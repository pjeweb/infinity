//     (c) 2012 Airbnb, Inc.
//
//     infinity.js may be freely distributed under the terms of the BSD
//     license. For all licensing information, details, and documentation:
//     http://airbnb.github.com/infinity
(function(e){if(typeof require=="function"&&typeof exports=="object"&&typeof module=="object")e(window,Math,require("jquery"),exports);else if(typeof define=="function"&&define.amd)define(["jquery","exports"],function(t,n){e(window,Math,t,n)});else{var t=window.infinity;e(window,Math,window.jQuery,window.infinity={},t)}})(function(e,t,n,r,i){"use strict";function c(t,r){r=r||{},this.$el=O(),this.$shadow=O(),t.append(this.$el),this.lazy=!!r.lazy,this.lazyFn=r.lazy||null,this.more=!!r.more,this.moreFn=r.more||null,h(this),this.top=this.$el.offset().top,this.width=0,this.height=0,this.pages=[],this.startIndex=0,this.$scrollParent=r.scrollParent||n(e),this.$scrollChild=r.scrollChild||this.$scrollParent,this.onPageMovingInDOM=undefined,this.onPageMovedInDOM=undefined,this.onPageAppendingToDOM=undefined,this.onPageAppendedToDOM=undefined,this.onPageRemovingFromDOM=undefined,this.onPageRemovedFromDOM=undefined,T.attach(this)}function h(e){e._$buffer=O().prependTo(e.$el)}function p(e){var t,n=e.pages,r=e._$buffer;n.length>0?(t=n[e.startIndex],r.height(t.top)):r.height(0)}function d(e,t,n){var r=e.length,i,s;for(i=n||0;i<r;i++)s=e[i],s.top+=t,s.bottom+=t,v(s.items,t)}function v(e,t,n){var r=e.length,i,s;for(i=n||0;i<r;i++)s=e[i],s.top+=t,s.bottom+=t}function m(e,t,n){t.$el.detach(),n?e.$el.prepend(t.$el):e.$el.append(t.$el),A(t,n?0:e.height),t.$el.detach()}function g(e){var n,r,i,s=e.pages,o=!1,u=!0;n=e.startIndex,r=t.min(n+l,s.length);for(n;n<r;n++)i=s[n],e.lazy&&i.lazyload(e.lazyFn),o&&i.onscreen&&(u=!1),u?i.onscreen||(e.onPageAppendingToDOM&&e.onPageAppendingToDOM(i),o=!0,i.appendTo(e.$el),e.onPageAppendedToDOM&&e.onPageAppendedToDOM(i)):(e.onPageMovingInDOM&&e.onPageMovingInDOM(i),i.stash(e.$shadow),i.appendTo(e.$el),e.onPageMovedInDOM&&e.onPageMovedInDOM(i))}function y(e,n){var r,i,s,o,u,a=e.startIndex,f=e.$scrollChild.scrollTop()-e.top,c=e.$scrollParent.height(),h=f+c,d=S(e,f,h);if(d<0||d===a&&!n)return a;s=e.pages,a=e.startIndex,o=t.min(a+l,s.length),u=t.min(d+l,s.length);for(r=a,i=o;r<i;r++)if(r<d||r>=u)e.onPageRemovingFromDOM&&e.onPageRemovingFromDOM(s[r]),s[r].stash(e.$shadow),e.onPageRemovedFromDOM&&e.onPageRemovedFromDOM(s[r]);return e.startIndex=d,g(e),p(e),d}function b(e,t,r){var i;return t instanceof L?t:(typeof t=="string"&&(t=n(t)),i=new L(t),m(e,i,r),i)}function w(e,t){E(e)}function E(e){var t,n,r,i,s,o,u,a,f,l=e.pages,c=[];n=new N(e),c.push(n);for(r=0,i=l.length;r<i;r++){t=l[r],u=t.items;for(s=0,o=u.length;s<o;s++)a=u[s],f=a.clone(),n.hasVacancy()?n.append(f):(n=new N(e),c.push(n),n.append(f));t.remove()}e.pages=c,g(e)}function S(e,n,r){var i=x(e,n,r);return i=t.max(i-f,0),i=t.min(i,e.pages.length),i}function x(e,n,r){var i,s,o,u,a,l,c,h=e.pages,p=n+(r-n)/2;u=t.min(e.startIndex+f,h.length-1);if(h.length<=0)return-1;o=h[u],a=o.top+o.height/2,c=p-a;if(c<0){for(i=u-1;i>=0;i--){o=h[i],a=o.top+o.height/2,l=p-a;if(l>0)return l<-c?i:i+1;c=l}return 0}if(c>0){for(i=u+1,s=h.length;i<s;i++){o=h[i],a=o.top+o.height/2,l=p-a;if(l<0)return-l<c?i:i-1;c=l}return h.length-1}return u}function N(e){this.parent=e,this.items=[],this.$el=O(),this.id=C.generatePageId(this),this.$el.attr(a,this.id),this.top=0,this.bottom=0,this.width=0,this.height=0,this.lazyloaded=!1,this.onscreen=!1}function k(e,t){var n,r,i,s=t.items;for(n=0,r=s.length;n<r;n++)if(s[n]===e){i=n;break}return i==null?!1:(s.splice(i,1),t.bottom-=e.height,t.height=t.bottom-t.top,t.hasVacancy()&&w(t.parent,t),!0)}function L(e){this.$el=e,this.parent=null,this.top=0,this.bottom=0,this.width=0,this.height=0}function A(e,t){var n=e.$el;e.top=t,e.height=n.outerHeight(!0),e.bottom=e.top+e.height,e.width=n.width()}function O(){return n("<div>").css({margin:0,padding:0,border:"none"})}function M(e){var t;e?(t=e.ListView,n.fn.listView=function(e){return new t(this,e)}):delete n.fn.listView}var s=n(e),o=r,u=o.config={},a="data-infinity-pageid",f=1,l=f*2+1;u.PAGE_TO_SCREEN_RATIO=3,u.SCROLL_THROTTLE=350,c.prototype.append=function(e){if(!e||!e.length)return null;var t,n=b(this,e),r=this.pages;this.height+=n.height,this.$el.height(this.height),t=r[r.length-1];if(!t||!t.hasVacancy())t=new N(this),r.push(t);return t.append(n),g(this),n},c.prototype.prepend=function(e){if(!e||!e.length)return null;var t,n=b(this,e,!0),r=this.pages;this.height+=n.height,this.$el.height(this.height),t=r[0];if(!t||!t.hasVacancy())t=new N(this),this.startIndex++,r.splice(0,0,t);return d(r,n.height,1),t.prepend(n),y(this,!0),n},c.prototype.remove=function(){this.$el.remove(),this.cleanup()},c.prototype.find=function(e){var t,r,i;return typeof e=="string"?(r=this.$el.find(e),i=this.$shadow.find(e),this.find(r).concat(this.find(i))):e instanceof L?[e]:(t=[],e.each(function(){var e,r,i,s,o,u,f=n(this).parentsUntil("["+a+"]").andSelf().first(),l=f.parent();e=l.attr(a),r=C.lookup(e);if(r){i=r.items;for(s=0,o=i.length;s<o;s++){u=i[s];if(u.$el.is(f)){t.push(u);break}}}}),t)},c.prototype.cleanup=function(){var e=this.pages,t;T.detach(this);while(t=e.pop())t.cleanup()};var T=function(){function i(){t||(setTimeout(o,u.SCROLL_THROTTLE),t=!0)}function o(){var e,n;for(e=0,n=r.length;e<n;e++){var i=r[e];y(i);var s=i.pages[i.pages.length-1],o=s.items[s.items.length-1];s.onscreen&&i.more&&(i.more=!1,i.moreFn(function(e){e=typeof e=="boolean"?e:!0,i.more=e}))}t=!1}function a(){n&&clearTimeout(n),n=setTimeout(f,200)}function f(){var e,t;for(e=0;t=r[e];e++)E(t)}var e=!1,t=!1,n=null,r=[];return{attach:function(t){t.eventIsBound||(t.$scrollChild.on("scroll",i),t.eventIsBound=!0),e||(s.on("resize",a),e=!0),r.push(t)},detach:function(t){var n,o;t.eventIsBound&&(t.$scrollChild.on("scroll",i),t.eventIsBound=!1);for(n=0,o=r.length;n<o;n++)if(r[n]===t)return r.splice(n,1),r.length===0&&(s.off("resize",a),e=!1),!0;return!1}}}();N.prototype.append=function(e){var t=this.items;t.length===0&&(this.top=e.top),this.bottom=e.bottom,this.width=this.width>e.width?this.width:e.width,this.height=this.bottom-this.top,t.push(e),e.parent=this,this.$el.append(e.$el),this.lazyloaded=!1},N.prototype.prepend=function(e){var t=this.items;this.bottom+=e.height,this.width=this.width>e.width?this.width:e.width,this.height=this.bottom-this.top,t.splice(0,0,e),e.parent=this,this.$el.prepend(e.$el),this.lazyloaded=!1},N.prototype.hasVacancy=function(){var e=this.parent.$scrollParent;return this.height<e.height()*u.PAGE_TO_SCREEN_RATIO},N.prototype.appendTo=function(e){this.onscreen||(this.$el.appendTo(e),this.onscreen=!0)},N.prototype.prependTo=function(e){this.onscreen||(this.$el.prependTo(e),this.onscreen=!0)},N.prototype.stash=function(e){this.onscreen&&(this.$el.appendTo(e),this.onscreen=!1)},N.prototype.remove=function(){this.onscreen&&(this.$el.detach(),this.onscreen=!1),this.cleanup()},N.prototype.cleanup=function(){var e=this.items,t;this.parent=null,C.remove(this);while(t=e.pop())t.cleanup()},N.prototype.lazyload=function(e){var t=this.$el,n,r;if(!this.lazyloaded){for(n=0,r=t.length;n<r;n++)e.call(t[n],t[n]);this.lazyloaded=!0}};var C=function(){var e=[];return{generatePageId:function(t){return e.push(t)-1},lookup:function(t){return e[t]||null},remove:function(t){var n=t.id;return e[n]?(e[n]=null,!0):!1}}}();L.prototype.clone=function(){var e=new L(this.$el);return e.top=this.top,e.bottom=this.bottom,e.width=this.width,e.height=this.height,e},L.prototype.remove=function(){this.$el.remove(),this.parent!==null&&k(this,this.parent),this.cleanup()},L.prototype.cleanup=function(){this.parent=null},o.ListView=c,o.Page=N,o.ListItem=L,M(o),o.noConflict=function(){return e.infinity=i,M(i),o}});